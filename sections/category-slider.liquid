<link rel="stylesheet" href="https://unpkg.com/swiper/swiper-bundle.min.css" />

<div class="product-slider-section">
	{% if section.settings.heading != blank %}
		<div class="slider-title">
			<h2>{{ section.settings.heading }}</h2>
		</div>
	{% endif %}
  <div class="swiper myProductSlider">
    <div class="swiper-wrapper">
      {% assign products = collections[section.settings.collection].products %}
      {% for product in products %}
        <div class="swiper-slide">
          <div class="product-card">
            <a href="{{ product.url }}">
              <img src="{{ product.featured_image | img_url: '400x' }}" alt="{{ product.title }}">
            </a>
            <div class="product-title">{{ product.title }}</div>
            <div class="product-price">
              {% if product.compare_at_price > product.price %}
                <span class="current">{{ product.price | money }}</span>
                <span class="compare">{{ product.compare_at_price | money }}</span>
              {% else %}
                <span class="current">{{ product.price | money }}</span>
              {% endif %}
            </div>
            <button 
              class="add-to-cart-btn" 
              data-id="{{ product.variants.first.id }}">
              {{ section.settings.button_text }}
            </button>
          </div>
        </div>
      {% endfor %}
    </div>
    <!-- Pagination -->
    <div class="swiper-pagination"></div>
  </div>
</div>

<script src="https://unpkg.com/swiper/swiper-bundle.min.js"></script>
<script>
  new Swiper(".myProductSlider", {
    slidesPerView: 2,
    spaceBetween: 15,
    breakpoints: {
      768: {
        slidesPerView: 4
      }
    },
    pagination: {
      el: ".swiper-pagination",
      clickable: true,
    }
  });

  document.addEventListener('click', function(e) {
    if (e.target.classList.contains('add-to-cart-btn')) {
      e.preventDefault();

      var btn = e.target;
      var id = btn.getAttribute('data-id');

      // Tambah state loading
      btn.disabled = true;
      btn.textContent = 'Adding...';

      fetch('/cart/add.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: id, quantity: 1 })
      })
      .then(res => {
        if (!res.ok) throw new Error('Network error');
        return res.json();
      })
      .then(data => {
        // Trigger update cart drawer di theme Dawn
        document.dispatchEvent(new CustomEvent('cart:refresh'));

        // Refresh cart data
        fetch('/cart.js')
          .then(res => res.json())
          .then(cart => {
            const cartIconBubble = document.getElementById('cart-icon-bubble');
            if (cartIconBubble) {
              const cartCountElement = cartIconBubble.querySelector('.cart-count');
              if (cartCountElement) {
                cartCountElement.textContent = cart.item_count;
              }
            }
          });

        // Ubah tombol jadi "Added!"
        btn.textContent = 'Added!';
        setTimeout(() => {
          btn.textContent = '{{ section.settings.button_text }}';
          btn.disabled = false;
        }, 2000);
      })
      .catch(err => {
        console.error(err);
        btn.textContent = 'Error';
        setTimeout(() => {
          btn.textContent = '{{ section.settings.button_text }}';
          btn.disabled = false;
        }, 2000);
      });
    }
  });
</script>

<style>
  .product-slider-section {
    padding: {{ section.settings.section_padding }}px 0;
  }
	.slider-title {
		margin-left: 25px;
	}
	.slider-title h2 {
		font-weight: 700;
		font-size: 24pt;
	}
  .product-card {
    text-align: center;
  }
  .product-card img {
    width: 100%;
    border-radius: {{ section.settings.image_radius }}px;
  }
  .product-title {
    font-size: 16px;
    margin-top: 8px;
		min-height: 60px;
  }
	.product-price > span {
		font-size: 16px;
		font-weight: 700;
		color: #000;
	}
  .product-price .compare {
    text-decoration: line-through;
    color: #999;
    margin-left: 5px;
  }
  .add-to-cart-btn {
    display: inline-block;
    margin-top: 8px;
    padding: 8px 14px;
    border-radius: {{ section.settings.button_radius }}px;
    background: {{ section.settings.button_bg }};
    color: {{ section.settings.button_color }};
    font-size: {{ section.settings.button_font_size }}px;
    cursor: pointer;
    border: none;
  }
  .add-to-cart-btn:hover {
    background: {{ section.settings.button_bg_hover }};
		color: {{ section.settings.button_color_hover }};
  }
	.product-slider-section .swiper-pagination {
		position: relative;
	}
	@media(max-width: 767px) {
		.product-title {
			min-height: 90px;
		}
		.product-slider-section .swiper-pagination {
			margin-top: 20px;
		}
	}
</style>

{% schema %}
{
  "name": "Product Category Slider",
  "settings": [
    {
      "type": "collection",
      "id": "collection",
      "label": "Select Collection"
    },
		{
			"type":"text",
			"id": "heading",
			"label": "Title Category Slider"
		},
    {
      "type": "range",
      "id": "section_padding",
      "label": "Section Padding (px)",
      "min": 0,
      "max": 100,
			"step": 1,
      "default": 30
    },
    {
      "type": "range",
      "id": "image_radius",
      "label": "Image Border Radius (px)",
      "min": 0,
      "max": 50,
			"step": 1,
      "default": 8
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "Add to Cart"
    },
    {
      "type": "color",
      "id": "button_bg",
      "label": "Button Background",
      "default": "#000"
    },
    {
      "type": "color",
      "id": "button_bg_hover",
      "label": "Button Hover Background",
      "default": "#333"
    },
    {
      "type": "color",
      "id": "button_color",
      "label": "Button Text Color",
      "default": "#fff"
    },
		{
      "type": "color",
      "id": "button_color_hover",
      "label": "Button Text Color Hover",
      "default": "#fff"
    },
    {
      "type": "range",
      "id": "button_radius",
      "label": "Button Border Radius (px)",
      "min": 0,
      "max": 50,
			"step": 1,
      "default": 6
    },
    {
      "type": "range",
      "id": "button_font_size",
      "label": "Button Font Size (px)",
      "min": 10,
      "max": 24,
			"step": 1,
      "default": 14
    }
  ],
  "presets": [
    {
      "name": "Product Category Slider",
      "category": "Custom"
    }
  ]
}
{% endschema %}
